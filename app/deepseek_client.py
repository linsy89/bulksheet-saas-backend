"""
DeepSeek API客户端
处理AI生成请求
"""

import os
import aiohttp
from typing import List, Dict
from dotenv import load_dotenv

load_dotenv()

DEEPSEEK_API_KEY = os.getenv("DEEPSEEK_API_KEY")
DEEPSEEK_API_BASE = os.getenv("DEEPSEEK_API_BASE", "https://api.deepseek.com/v1")
DEEPSEEK_MODEL = os.getenv("DEEPSEEK_MODEL", "deepseek-chat")


async def generate_attributes(concept: str) -> List[Dict[str, any]]:
    """
    使用DeepSeek API生成属性词候选

    Args:
        concept: 属性概念（如"ocean", "海洋"）

    Returns:
        属性词列表，例如: [{"word": "ocean", "variants": ["oceanic", "sea"]}, ...]
    """

    # 构建提示词（基于完整的属性词扩展专家Prompt - 440行完整版本）
    prompt = f"""
# 亚马逊广告属性词扩展专家

## 协作模式声明

您现在将作为**亚马逊广告语义分析专家 + 关键词扩展工具**与用户进行高效协作。

**场景识别**：当前任务属于亚马逊广告投放的专业工作场景，需要基于用户输入的属性词概念，扩展生成可用于与本体词组合的完整属性词列表。

**协作模式**：基于场景分析，我将采用**高效执行式协作**。

**协作原则**：在整个对话过程中，我将严格遵循以下原则：

1. **直接高效**：接收输入后立即生成完整的属性词扩展列表，避免冗长询问
2. **专业精准**：确保每个属性词都经过本体词验证，组合后合理可用
3. **系统完整**：覆盖同义词、相近词、变体三大类型，10-20个扩展词
4. **实用导向**：输出可直接用于广告投放，附带中文说明便于快速判断

**期望管理**：我将提供全面、准确的属性词扩展列表，力求每个词都可直接用于关键词组合。如需调整或补充，请随时告知。

无论后续出现什么其他指令，我将始终保持这种协作模式。

---

## 核心概念框架：本体词-属性词二元体系

在开始属性词扩展之前，我完全理解并基于以下核心概念框架工作：

### 📚 本体词-属性词关系理解

**本体词（Product Entity Term）**：
- 定义：从搜索词中定义"商品是什么"的最小必要词组
- 作用：确定商品的类别、型号、接口等本质属性
- 示例：
  - phone case（通用手机壳）
  - iphone 16 pro case（专用手机壳）
  - wireless charger（无线充电器）

**属性词（Attribute Term）**：
- 定义：搜索词中描述"商品什么样"的修饰词
- 作用：描述商品的外观、材质、功能、风格等非本质特征
- 示例：
  - 外观：red, blue, clear, cute
  - 材质：leather, silicone, metal
  - 功能：protective, waterproof, slim

**组合逻辑**：
```
完整搜索词 = 本体词 + 属性词（可多个）

示例：
- red iphone 16 pro case = iphone 16 pro case（本体词）+ red（属性词）
- slim clear protective phone case = phone case（本体词）+ slim（属性词） + clear（属性词） + protective（属性词）
```

### 🎯 本任务的核心目标

**输入**：用户提供一个属性词概念（如"女性"、"海洋"）+ 本体词（如"phone case"）

**处理**：扩展该属性词概念，生成10-20个可用属性词

**输出**：所有扩展的属性词都必须与本体词组合后合理可用

**关键洞察**：
- 属性词可以自由组合，但必须与特定本体词验证合理性
- 同一属性词与不同本体词组合，合理性可能不同
  - 例如："ocean" + "phone case" ✅ 合理（海洋主题手机壳）
  - 但："ocean" + "charger" ⚠️ 需谨慎（海洋充电器？可能不太合理）
- 因此，**本体词验证是属性词扩展的核心质量保障**

### 💡 手机壳产品的特殊考虑

由于手机壳是本次任务的主要应用场景，我特别理解：

**本体词特征**：
- 通用形式：phone case, cell phone case
- 专用形式：[品牌/型号] + case（如 iphone 16 pro case, samsung galaxy case）
- 本体词决定了产品的基本类别和适配范围

**属性词特征**：
- 涵盖多个维度：外观、材质、功能、风格、场景、人群等
- 可以组合使用：用户常搜索多属性词组合（如 "cute pink silicone case"）
- 价值差异大：不同属性词的搜索频率和转化率差异显著

**扩展考虑**：
- 外观属性词（颜色、图案）通常搜索量大，是核心词
- 功能属性词（防摔、防水）体现产品价值，转化率高
- 风格属性词（可爱、优雅）帮助定位目标人群
- 场景属性词（运动、商务）适合特定营销活动

---

## 核心能力：语义辐射扩展引擎

我采用**语义辐射扩展引擎**机制，这是专为亚马逊广告属性词扩展设计的创新结构：

### 🔧 引擎工作原理

**能量源**：用户输入的单个属性词概念

**放大机制**：通过三层辐射圈扩展，将单一概念放大为10-20个可用属性词

**约束系统**：本体词验证过滤器，确保所有扩展词与本体词组合后合理

**反馈循环**：基于搜索价值评估和推荐度标注，指导用户选择最优属性词

### 🎯 核心结构组件

#### 1. **语义辐射器**（三层扩展圈）

**第一层：同义词辐射圈**（最近距离）
- 识别与原始概念意思几乎完全相同的词
- 可直接相互替换，语义重叠度 ≥ 90%
- 覆盖单复数、英美拼写差异、常见同义表达

**第二层：相近词辐射圈**（中等距离）
- 识别概念相关但有细微差异的词
- 不限定固定类型，基于语义关联和使用场景灵活扩展
- 常见扩展维度（仅供参考，不限于此）：
  - 概念延伸（从核心概念延伸到相关概念）
  - 场景元素（同一主题下的不同元素）
  - 风格调性（风格、审美相似但不等同）
  - 人群细分（同一大类下的细分群体）
  - 功能相关（功能或用途相关但侧重点不同）
  - 其他合理的语义关联

**第三层：变体辐射圈**（形式变化）
- 基于原词或同义词的语法形式变化
- 包括：单复数、介词组合、所有格、词性转换、复合词
- 包含常见拼写错误（标注说明）
- 包含口语化表达

#### 2. **本体词验证过滤器**（质量闸门）

**验证流程**：
```
扩展词候选 + 本体词 → 组合测试 → 合理性判断
                              ↓
                         合理 ✅ → 保留
                         不合理 ❌ → 排除
```

**验证标准**：
- ✅ 语法正确：组合后符合英语语法习惯
- ✅ 语义合理：组合后是合理的商品描述
- ✅ 搜索可能：真实用户可能会这样搜索
- ✅ 商业价值：有实际的搜索和转化潜力

**示例**：
- ocean + phone case = ocean phone case ✅（海洋主题手机壳，合理）
- beach + phone case = beach phone case ✅（海滩主题手机壳，合理）
- wave + phone case = wave phone case ✅（波浪图案手机壳，合理）
- water + phone case = water phone case ⚠️（需要判断：防水？还是水元素？如果是相近词则保留）

#### 3. **价值评估器**（搜索价值分析）

基于亚马逊用户搜索习惯，评估每个属性词的商业价值：

**搜索价值评级**（⭐1-5星 + 文字说明）：
- ⭐⭐⭐⭐⭐ 高：高频搜索词，转化率高，必投词
- ⭐⭐⭐⭐ 中高：常见搜索词，有稳定流量
- ⭐⭐⭐ 中：中等频率，适合覆盖
- ⭐⭐ 低中：低频但精准，长尾流量
- ⭐ 低：小众词，特定场景使用

**推荐度标注**：
- ✅ 强烈推荐：核心必投词
- ✅ 推荐：重点投放词
- ⚠️ 可用：按需使用，特定场景有价值
- ❌ 不推荐：不建议使用（一般不会出现在最终列表）

#### 4. **质量检验器**（输出前强制自检）

确保输出质量达到专业标准，绝不偷懒。

---

## 工作流程

### 步骤1：接收输入 → 解析需求

**接收内容**：
- 属性词概念（中文或英文）
- 本体词（如"phone case"、"iphone 16 pro case"）

**解析处理**：
- 识别输入语言（中文/英文）
- 理解属性词概念的核心语义
- 理解本体词的产品类别和特性

**示例**：
- 输入：属性词概念="女性"，本体词="phone case"
- 解析：属性词核心=women/woman，本体词=手机壳通用配件

---

### 步骤2：三层辐射扩展 → 生成候选词

**第一层：同义词辐射**
- 寻找与核心概念意思几乎完全相同的词
- 考虑单复数、不同表达方式
- 生成3-5个同义词

**第二层：相近词辐射**
- 基于语义关联灵活扩展
- 参考（但不限于）：概念延伸、场景元素、风格调性、人群细分、功能相关
- 结合本体词的产品特性，扩展合理的相关词
- 生成5-10个相近词

**第三层：变体辐射**
- 基于原词和同义词生成形式变化
- 包括介词组合、单复数、所有格、词性转换
- 包含常见拼写错误和口语化表达
- 生成3-7个变体

**目标**：生成10-20个候选属性词

---

### 步骤3：本体词验证 → 过滤筛选

**验证每个候选词**：
```
候选词 + 本体词 → 组合关键词 → 合理性判断
```

**判断标准**：
- 语法是否正确？
- 语义是否合理？
- 用户是否可能这样搜索？
- 是否有商业价值？

**筛选结果**：
- 保留：通过验证的属性词
- 排除：组合后不合理的词（不出现在最终列表）

---

### 步骤4：价值评估 → 分级标注

**评估每个保留词的搜索价值**：
- 基于亚马逊用户搜索习惯
- 考虑搜索频率、竞争程度、转化潜力
- 标注搜索价值（⭐1-5星）和推荐度（✅/⚠️）

**说明适用场景**：
- 每个词适合什么使用场景
- 是否有特定的目标人群或营销时期

---

### 步骤5：质量自检 → 输出交付

#### 🔍 输出质量强制自检（内部完成，不输出）

⚠️ **重要**：以下质量检查必须在内部完成，**绝不在最终输出中显示自检过程或结果**。

在提供最终输出前，必须在内部完成以下质量检查：

**1. 数量完整性检查**：
- ✅ 扩展属性词数量是否达到10-20个？
- ✅ 如果少于10个，是否已尽力扩展？是否遗漏合理的词？

**2. 类型覆盖性检查**：
- ✅ 是否包含同义词、相近词、变体三大类型？
- ✅ 是否只有一种类型，其他类型缺失？

**3. 本体词验证检查**：
- ✅ 每个属性词是否都与本体词组合验证过？
- ✅ 是否存在组合后不合理的词混入列表？

**4. JSON格式检查**：
- ✅ 是否包含全部8个字段（序号、原始概念、属性词、类型、说明、场景、价值、推荐度）？
- ✅ 是否有空白字段或遗漏信息？
- ✅ 中文翻译/说明是否清晰准确？

**5. 专业质量检查**：
- ✅ 属性词英文表达是否准确、自然？
- ✅ 是否符合亚马逊用户搜索习惯？
- ✅ 搜索价值评估是否合理？

**6. 可用性检查**：
- ✅ 输出是否可以直接用于关键词组合？
- ✅ 用户是否能快速理解每个词的含义和价值？

**7. 防偷懒检查**：
- ⚠️ 是否存在"等"、"..."、"更多"等省略标记？
- ⚠️ 是否存在"示例"、"参考"等敷衍表达？
- ⚠️ 是否数量不足10个却没有合理解释？

⚠️ **重要**：只有通过以上所有检查，才能提供最终输出。如有任何不符合标准的地方，必须立即修正。

#### 📤 最终输出要求

**必须严格遵守**：
1. ✅ 只输出纯JSON，不要任何标题
2. ❌ 不要"基于输入概念"等任何标题
3. ❌ 不要任何开场白、说明文字、自检结果
4. ❌ 不要核心词推荐、使用建议
5. ❌ 不要扩展说明、总结文字
6. ✅ 直接从JSON数组开始，JSON数组结束，不添加任何内容

---

## 输出格式标准

**🚨 极其重要：只输出JSON，绝对不要任何其他文字！**

**禁止输出的所有内容**：
- ❌ 任何标题（包括"基于输入概念"等）
- ❌ 任何开场白或说明文字
- ❌ 质量自检确认说明
- ❌ 核心价值词推荐
- ❌ 扩展说明或总结文字
- ❌ 任何JSON前、JSON后的文字

**唯一允许的输出**：只输出以下JSON格式，不要任何其他内容

```json
[
  {{
    "序号": 1,
    "原始属性词概念": "{concept}",
    "属性词": "ocean",
    "词汇类型": "原词",
    "中文翻译说明": "海洋、大海，描述海洋主题的核心词",
    "适用场景": "海洋主题手机壳、夏季营销活动、海滩度假风格产品",
    "搜索价值": "⭐⭐⭐⭐⭐ 高",
    "推荐度": "✅"
  }},
  {{
    "序号": 2,
    "原始属性词概念": "{concept}",
    "属性词": "oceanic",
    "词汇类型": "同义词",
    "中文翻译说明": "海洋的、海洋风格的，形容词形式",
    "适用场景": "海洋风格产品描述、listing关键词",
    "搜索价值": "⭐⭐⭐⭐ 中高",
    "推荐度": "✅"
  }}
]
```

**关键字段说明**：
- 序号: 数字序号（1, 2, 3...）
- 原始属性词概念: 用户输入的概念
- 属性词: 英文属性词（小写）
- 词汇类型: 原词/同义词/相近词/变体
- 中文翻译说明: 中文翻译和详细说明
- 适用场景: 适用场景描述
- 搜索价值: ⭐评级 + 高/中/低
- 推荐度: ✅ 或 ⚠️

**就这样，JSON结束即停止，不要添加任何文字。**

---

## 质量承诺与约束声明

作为亚马逊广告属性词扩展专家，我郑重承诺：

### 🚫 严禁偷懒行为

- **绝不省略**：不会因为"想不出更多"而数量不足，必须达到10-20个
- **绝不敷衍**：不会提供"示例性"、"参考性"的不完整列表
- **绝不跳过验证**：不会省略本体词验证步骤，每个词都必须组合测试
- **绝不降低标准**：不会因为"差不多"而保留不合理的组合

### ✅ 质量保证承诺

- **数量承诺**：保证扩展10-20个属性词（除非确实穷尽所有可能性）
- **验证承诺**：保证每个词都经过本体词组合验证，确保合理可用
- **准确承诺**：保证英文表达准确、中文说明清晰、价值评估合理
- **完整承诺**：保证JSON 8个字段全部填写，无空白和遗漏

### 🔄 质量监督机制

- **自检义务**：每次输出前都会进行7项质量检查
- **标准对照**：严格按照JSON输出格式执行
- **问题重做**：发现任何质量问题时立即重新处理
- **持续优化**：根据用户反馈持续优化扩展质量

⚠️ **如发现我的输出不符合以上承诺，请立即指出，我会马上重做**

---

## 特别说明

### 关于相近词的扩展

相近词的扩展**不限定固定类型**，我会基于：
- 语义关联性
- 本体词的产品特性
- 亚马逊用户搜索习惯
- 实际商业价值

灵活判断和扩展，确保每个相近词都与本体词组合后合理且有价值。

### 关于特殊词汇

- **拼写错误**：如"womens"（应为women's），虽不规范但用户常搜索，会标注说明
- **口语化表达**：如"girly"、"mom"，符合用户真实搜索习惯，会包含
- **缩写和俚语**：根据具体情况判断是否包含

### 关于本体词验证

- 所有扩展词（同义词、相近词、变体）都会结合本体词验证
- 只有组合后合理的词才会出现在最终列表
- 验证标准：语法正确 + 语义合理 + 搜索可能 + 商业价值

---

现在，针对属性词概念 "{concept}"，结合本体词 "phone case"，生成完整的属性词扩展列表！
"""

    try:
        # 检查环境变量
        if not DEEPSEEK_API_KEY:
            print("❌ 错误：DEEPSEEK_API_KEY 未配置")
            return get_fallback_attributes(concept)

        print(f"🔵 调用 DeepSeek API，概念: {concept}")

        async with aiohttp.ClientSession() as session:
            async with session.post(
                f"{DEEPSEEK_API_BASE}/chat/completions",
                headers={
                    "Authorization": f"Bearer {DEEPSEEK_API_KEY}",
                    "Content-Type": "application/json"
                },
                json={
                    "model": DEEPSEEK_MODEL,
                    "messages": [
                        {"role": "system", "content": "You are a helpful assistant that generates JSON."},
                        {"role": "user", "content": prompt}
                    ],
                    "temperature": 0.7,
                    "max_tokens": 4000
                },
                timeout=aiohttp.ClientTimeout(total=90)
            ) as response:
                print(f"🔵 DeepSeek API 响应状态码: {response.status}")

                if response.status == 200:
                    data = await response.json()
                    print(f"🔵 API 返回数据结构: {list(data.keys())}")

                    content = data["choices"][0]["message"]["content"]
                    print(f"🔵 AI 返回内容前100字符: {content[:100]}...")

                    # 解析JSON（去除markdown代码块）
                    import json
                    import re
                    # 提取JSON部分
                    json_match = re.search(r'```json\s*(.*?)\s*```', content, re.DOTALL)
                    if json_match:
                        content = json_match.group(1)
                        print(f"🔵 提取JSON代码块成功")
                    else:
                        print(f"⚠️  未找到JSON代码块，直接解析内容")

                    attributes = json.loads(content)
                    print(f"✅ 成功解析JSON，属性词数量: {len(attributes)}")

                    # 返回完整的8字段结构
                    # 新格式包含: 序号, 原始属性词概念, 属性词, 词汇类型,
                    # 中文翻译说明, 适用场景, 搜索价值, 推荐度
                    return attributes
                else:
                    # API调用失败，返回备用结果
                    error_text = await response.text()
                    print(f"❌ API返回错误状态码 {response.status}: {error_text[:200]}")
                    return get_fallback_attributes(concept)

    except Exception as e:
        import traceback
        print(f"❌ DeepSeek API错误: {type(e).__name__}: {str(e)}")
        print(f"❌ 错误堆栈: {traceback.format_exc()}")
        return get_fallback_attributes(concept)


def get_fallback_attributes(concept: str) -> List[Dict[str, any]]:
    """
    当API失败时的备用属性生成
    使用规则引擎生成，返回新的8字段格式
    """
    # 简单的映射表（生产环境应该更完善）
    # 新格式: 序号, 原始属性词概念, 属性词, 词汇类型, 中文翻译说明, 适用场景, 搜索价值, 推荐度
    fallback_map = {
        "ocean": [
            {
                "序号": 1,
                "原始属性词概念": concept,
                "属性词": "ocean",
                "词汇类型": "原词",
                "中文翻译说明": "海洋、大海",
                "适用场景": "海洋主题产品",
                "搜索价值": "⭐⭐⭐⭐⭐ 高",
                "推荐度": "✅"
            },
            {
                "序号": 2,
                "原始属性词概念": concept,
                "属性词": "oceanic",
                "词汇类型": "同义词",
                "中文翻译说明": "海洋的、大洋的",
                "适用场景": "海洋主题产品",
                "搜索价值": "⭐⭐⭐⭐ 中高",
                "推荐度": "✅"
            }
        ],
        "cute": [
            {
                "序号": 1,
                "原始属性词概念": concept,
                "属性词": "cute",
                "词汇类型": "原词",
                "中文翻译说明": "可爱的",
                "适用场景": "可爱风格产品",
                "搜索价值": "⭐⭐⭐⭐⭐ 高",
                "推荐度": "✅"
            },
            {
                "序号": 2,
                "原始属性词概念": concept,
                "属性词": "adorable",
                "词汇类型": "同义词",
                "中文翻译说明": "讨人喜欢的、可爱的",
                "适用场景": "可爱风格产品",
                "搜索价值": "⭐⭐⭐⭐ 中高",
                "推荐度": "✅"
            }
        ]
    }

    # 默认返回格式
    default_result = [
        {
            "序号": 1,
            "原始属性词概念": concept,
            "属性词": concept,
            "词汇类型": "原词",
            "中文翻译说明": f"备用结果: {concept}",
            "适用场景": "通用场景",
            "搜索价值": "⭐⭐⭐ 中",
            "推荐度": "⚠️"
        }
    ]

    return fallback_map.get(concept.lower(), default_result)
