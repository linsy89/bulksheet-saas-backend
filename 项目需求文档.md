# Bulksheet SaaS 项目需求文档

**版本**: v1.0
**最后更新**: 2025-11-06
**项目状态**: Stage 1 已完成，Stage 2-4 规划中

---

## 目录

- [1. 项目概述](#1-项目概述)
- [2. 已完成功能 - Stage 1](#2-已完成功能---stage-1)
- [3. 技术架构](#3-技术架构)
- [4. 后续功能规划](#4-后续功能规划)
- [5. 开发路线图](#5-开发路线图)

---

## 1. 项目概述

### 1.1 项目背景

Bulksheet SaaS 是一个专为亚马逊广告优化设计的AI驱动型关键词扩展工具。该项目旨在帮助广告投放人员快速生成、筛选和组织搜索关键词，最终导出为亚马逊广告Bulksheet格式，提升广告投放效率。

### 1.2 核心价值

- **智能扩展**：基于AI的语义分析，自动扩展属性词候选集
- **精准筛选**：提供同义词、相近词、变体词等多维度扩展
- **高效导出**：一键生成符合亚马逊广告规范的Bulksheet文件
- **可配置化**：支持多AI提供商切换，提示词版本化管理

### 1.3 核心概念：本体词-属性词二元体系

**本体词（Product Entity Term）**
- 定义：描述"商品是什么"的核心词汇
- 示例：`phone case`、`iphone 16 pro case`、`laptop stand`
- 作用：确定商品类别和产品范围

**属性词（Attribute Term）**
- 定义：描述"商品什么样"的修饰词汇
- 示例：`red`、`cute`、`protective`、`waterproof`
- 作用：细化商品特征，提升搜索精准度

**组合逻辑**
```
完整搜索词 = 本体词 + 属性词（可多个）
示例：cute phone case, red iphone 16 pro case
```

### 1.4 产品工作流程

```
输入属性概念 → AI生成属性词候选 → 用户筛选编辑 → 组合生成搜索词 → 导出Bulksheet
   (Stage 1)          (Stage 1)         (Stage 2)        (Stage 3)         (Stage 4)
```

---

## 2. 已完成功能 - Stage 1

### 2.1 功能概述

**Stage 1：属性词候选生成**

基于用户输入的属性概念和本体词，调用AI模型生成属性词候选列表，包含原词、同义词、相近词和变体词。

### 2.2 API 文档

#### 2.2.1 属性词生成接口

**端点**: `POST /api/stage1/generate`

**描述**: 根据属性概念和本体词生成属性词候选列表

**请求体**:
```json
{
  "concept": "cute",
  "entity_word": "iphone 16 pro case"
}
```

**请求字段说明**:

| 字段 | 类型 | 必填 | 默认值 | 说明 |
|------|------|------|--------|------|
| `concept` | string | 是 | - | 属性概念，如"ocean"、"女性"、"protective" |
| `entity_word` | string | 否 | "phone case" | 本体词，描述产品类型 |

**响应体**:
```json
{
  "concept": "cute",
  "entity_word": "iphone 16 pro case",
  "task_id": "550e8400-e29b-41d4-a716-446655440000",
  "attributes": [
    {
      "word": "cute",
      "concept": "cute",
      "type": "original",
      "translation": "可爱的，常用于描述具有吸引力的设计",
      "use_case": "适用于希望体现可爱风格的手机壳产品",
      "search_value": "high",
      "search_value_stars": 5,
      "recommended": true
    },
    {
      "word": "adorable",
      "concept": "cute",
      "type": "synonym",
      "translation": "讨人喜欢的、惹人爱的",
      "use_case": "适用于强调可爱程度的产品描述",
      "search_value": "high",
      "search_value_stars": 4,
      "recommended": true
    }
  ],
  "metadata": {
    "total_count": 15,
    "generated_at": "2025-11-06T14:30:00Z",
    "original_count": 1,
    "synonym_count": 2,
    "related_count": 6,
    "variant_count": 6
  }
}
```

**响应字段说明**:

| 字段 | 类型 | 说明 |
|------|------|------|
| `concept` | string | 输入的属性概念 |
| `entity_word` | string | 输入的本体词 |
| `task_id` | string | 任务唯一标识符（UUID格式） |
| `attributes` | array | 属性词列表 |
| `metadata` | object | 元数据统计信息 |

**属性词对象字段**:

| 字段 | 类型 | 可选值 | 说明 |
|------|------|--------|------|
| `word` | string | - | 属性词（英文） |
| `concept` | string | - | 原始属性词概念 |
| `type` | string | original/synonym/related/variant | 词汇类型 |
| `translation` | string | - | 中文翻译和详细说明 |
| `use_case` | string | - | 适用场景描述 |
| `search_value` | string | high/medium/low | 搜索价值评级 |
| `search_value_stars` | integer | 1-5 | 搜索价值星级 |
| `recommended` | boolean | true/false | 是否推荐使用 |

**词汇类型说明**:

- `original`: 原词，与输入概念完全一致
- `synonym`: 同义词，语义重叠度 ≥ 90%
- `related`: 相近词，基于语义关联扩展
- `variant`: 变体词，包括单复数、介词组合、拼写变体等

**元数据字段**:

| 字段 | 类型 | 说明 |
|------|------|------|
| `total_count` | integer | 属性词总数 |
| `generated_at` | string | 生成时间（ISO 8601格式） |
| `original_count` | integer | 原词数量 |
| `synonym_count` | integer | 同义词数量 |
| `related_count` | integer | 相近词数量 |
| `variant_count` | integer | 变体数量 |

**状态码**:

- `200 OK`: 成功生成属性词
- `400 Bad Request`: 请求参数错误
- `500 Internal Server Error`: 服务器内部错误（包括AI API调用失败）

**错误响应示例**:
```json
{
  "detail": "concept字段不能为空"
}
```

#### 2.2.2 健康检查接口

**端点**: `GET /` 或 `GET /health`

**描述**: 检查服务运行状态

**响应体**:
```json
{
  "status": "running",
  "service": "Bulksheet SaaS API",
  "version": "1.0.0"
}
```

### 2.3 功能特性

#### 2.3.1 AI语义扩展引擎

**三层辐射圈扩展机制**：

1. **同义词辐射圈**（最近距离）
   - 语义重叠度 ≥ 90%
   - 可直接替换使用
   - 示例：cute → adorable, lovely

2. **相近词辐射圈**（中等距离）
   - 基于语义关联灵活扩展
   - 扩展维度：
     - 概念延伸（cute → kawaii, charming）
     - 场景元素（ocean → beach, wave）
     - 风格调性（cute → sweet, playful）
     - 人群细分（女性 → girl, lady）
     - 功能相关（protective → shockproof）

3. **变体辐射圈**（形式变化）
   - 单复数变化（case → cases）
   - 介词组合（for iphone, with strap）
   - 所有格形式（women's, girl's）
   - 常见拼写错误（colour → color）
   - 口语化表达（phone → cell phone）

#### 2.3.2 质量保证机制

**本体词验证过滤器**：
- 自动识别并过滤包含本体词的属性词
- 示例：如果本体词是"phone case"，则过滤掉"phone case protective"，只保留"protective"

**价值评估器**：
- 根据搜索热度、语义相关性、用户意图匹配度进行评分
- 分为三级：高（5星/4星）、中（3星）、低（2星/1星）

**推荐度标识**：
- ✅ 推荐（`recommended: true`）：高价值、常用词汇
- ⚠️ 谨慎（`recommended: false`）：低价值或小众词汇

#### 2.3.3 容错机制

**API调用失败处理**：
- 自动捕获异常并记录详细错误日志
- 降级到备用数据（预定义常见概念的属性词）
- 保证服务可用性，不返回空结果

**备用数据覆盖概念**：
- ocean（海洋主题）
- cute（可爱风格）
- 其他概念返回基础默认结果

### 2.4 数据模型

#### 2.4.1 Pydantic 模型定义

项目使用Pydantic进行数据验证和序列化，所有模型定义在 `app/models.py` 中。

**核心模型层级**：
```
AttributeRequest (请求)
    ├── concept: str
    └── entity_word: str

AttributeResponse (响应)
    ├── concept: str
    ├── entity_word: str
    ├── task_id: str
    ├── attributes: List[AttributeWord]
    └── metadata: AttributeMetadata

AttributeWord (属性词实体)
    ├── word: str
    ├── concept: str
    ├── type: Literal[...]
    ├── translation: str
    ├── use_case: str
    ├── search_value: Literal[...]
    ├── search_value_stars: int
    └── recommended: bool

AttributeMetadata (元数据)
    ├── total_count: int
    ├── generated_at: str
    ├── original_count: int
    ├── synonym_count: int
    ├── related_count: int
    └── variant_count: int
```

#### 2.4.2 数据转换机制

**中英文字段映射**：

AI模型（DeepSeek）返回中文字段，需要转换为标准英文字段：

| 中文字段 | 英文字段 | 转换逻辑 |
|---------|---------|---------|
| 原始属性词概念 | concept | 直接映射 |
| 属性词 | word | 直接映射 |
| 词汇类型 | type | 原词→original, 同义词→synonym, 相近词→related, 变体→variant |
| 中文翻译说明 | translation | 直接映射 |
| 适用场景 | use_case | 直接映射 |
| 搜索价值 | search_value + search_value_stars | ⭐⭐⭐⭐⭐→high(5星), ⭐⭐⭐⭐→high(4星), ⭐⭐⭐→medium(3星) |
| 推荐度 | recommended | ✅→true, ⚠️→false |

**转换函数**：`convert_deepseek_to_standard()` (main.py:58-113)

### 2.5 AI服务集成

#### 2.5.1 DeepSeek 提供商

**模型**: `deepseek-chat`
**API Base**: `https://api.deepseek.com/v1`

**配置参数**：
- `max_tokens`: 4000（最大输出token数）
- `timeout`: 90秒（请求超时时间）
- `temperature`: 0.7（生成温度，平衡创造性和一致性）

#### 2.5.2 提示词工程

**提示词版本**: v1
**文件路径**: `backend_v2/app/config/prompts/attribute_expert_v1.txt`

**提示词规模**: 413行专家级Prompt

**核心组件**：
1. 协作模式声明（定义AI角色和协作规范）
2. 本体词-属性词二元体系说明
3. 三层语义辐射扩展引擎逻辑
4. 本体词验证过滤规则
5. 价值评估标准
6. 输出格式规范
7. 质量保证机制

**动态参数**：
- `{concept}`: 用户输入的属性概念
- 提示词模板在运行时动态填充该参数

### 2.6 测试结果

#### 测试用例1：概念="ocean"
```bash
curl -X POST http://localhost:8000/api/stage1/generate \
  -H "Content-Type: application/json" \
  -d '{"concept": "ocean"}'
```

**结果**：
- 生成20个属性词
- 包含：原词1个、同义词3个、相近词10个、变体6个
- 高价值词汇：ocean, oceanic, sea, marine

#### 测试用例2：概念="cute", 本体词="iphone 16 pro case"
```bash
curl -X POST http://localhost:8000/api/stage1/generate \
  -H "Content-Type: application/json" \
  -d '{"concept": "cute", "entity_word": "iphone 16 pro case"}'
```

**结果**：
- 生成15个属性词
- 包含：原词1个、同义词2个、相关词6个、变体6个
- 高价值词汇：cute, adorable, lovely, kawaii
- AI正确理解产品类型并生成适配属性

---

## 3. 技术架构

### 3.1 技术栈

#### 后端框架
- **FastAPI** 0.121.0 - 现代化Python Web框架
- **Uvicorn** 0.38.0 - ASGI服务器
- **Pydantic** 2.12.3 - 数据验证和序列化

#### 异步HTTP
- **aiohttp** 3.13.2 - 异步HTTP客户端

#### 配置管理
- **python-dotenv** 1.2.1 - 环境变量管理
- **PyYAML** 6.0.1 - YAML配置文件解析

#### 数据处理（预留）
- **pandas** 2.3.3 - 数据分析和处理
- **openpyxl** 3.1.5 - Excel文件读写

#### AI服务
- **DeepSeek API** - AI属性词生成

### 3.2 架构设计

#### 3.2.1 分层架构

```
┌─────────────────────────────────────┐
│         API 层 (main.py)            │  FastAPI路由和端点
├─────────────────────────────────────┤
│     数据模型层 (models.py)           │  Pydantic数据验证
├─────────────────────────────────────┤
│  服务抽象层 (ai_service.py)         │  AIService接口
├─────────────────────────────────────┤
│ 服务实现层 (deepseek_provider.py)   │  DeepSeekProvider实现
├─────────────────────────────────────┤
│   配置管理层 (config/__init__.py)    │  配置加载和提示词管理
├─────────────────────────────────────┤
│   配置文件层 (ai_config.yaml)       │  YAML配置文件
│   提示词文件 (prompts/*.txt)        │  版本化提示词模板
└─────────────────────────────────────┘
```

#### 3.2.2 设计模式

**1. 抽象工厂模式**

目的：支持多AI提供商扩展

```python
# 抽象基类
class AIService(ABC):
    @abstractmethod
    async def generate_attributes(self, concept: str, entity_word: str) -> List[Dict]:
        pass

# 具体实现
class DeepSeekProvider(AIService):
    async def generate_attributes(self, concept: str, entity_word: str) -> List[Dict]:
        # DeepSeek实现
        ...

# 未来可添加
class OpenAIProvider(AIService):
    async def generate_attributes(self, concept: str, entity_word: str) -> List[Dict]:
        # OpenAI实现
        ...
```

**2. 策略模式**

目的：通过配置文件切换AI提供商

```yaml
# ai_config.yaml
active_provider: "deepseek"  # 切换为 "openai" 即可使用不同提供商
```

**3. 模板方法模式**

目的：提示词动态参数化

```python
prompt_template = load_prompt("attribute_expert", version="v1")
prompt = prompt_template.format(concept=concept)  # 动态填充
```

**4. 依赖注入**

目的：解耦配置和业务逻辑

```python
# 启动时注入
ai_config = load_ai_config()
prompt_template = load_prompt("attribute_expert", version="v1")
ai_service = DeepSeekProvider(config=provider_config, prompt_template=prompt_template)

# 使用时直接调用
attributes = await ai_service.generate_attributes(concept, entity_word)
```

### 3.3 配置管理架构

#### 3.3.1 三层配置结构

**1. 环境变量层（.env）**
```env
DEEPSEEK_API_KEY=sk-xxxxx
```
- 存储敏感信息（API Key）
- 不纳入版本控制（.gitignore）

**2. YAML配置层（ai_config.yaml）**
```yaml
providers:
  deepseek:
    api_key_env: "DEEPSEEK_API_KEY"
    api_base: "https://api.deepseek.com/v1"
    model: "deepseek-chat"
    max_tokens: 4000
    timeout: 90
    temperature: 0.7

active_provider: "deepseek"
prompt_version: "v1"
```
- 管理AI提供商配置
- 纳入版本控制
- 易于修改和扩展

**3. 提示词文件层（prompts/）**
```
prompts/
├── attribute_expert_v1.txt   (当前版本)
├── attribute_expert_v2.txt   (未来版本)
└── ...
```
- 版本化管理提示词
- 支持A/B测试
- 独立于代码更新

#### 3.3.2 配置加载机制

**配置加载函数**（config/__init__.py）：

1. `load_ai_config()` - 加载AI配置文件
   - 读取 `ai_config.yaml`
   - 如果文件不存在，返回默认配置

2. `load_prompt(name, version)` - 加载提示词模板
   - 根据名称和版本动态加载
   - 示例：`load_prompt("attribute_expert", "v1")`
   - 返回完整提示词文本

3. `get_default_ai_config()` - 获取默认配置
   - 当配置文件不存在时的降级方案
   - 保证服务可用性

### 3.4 项目文件结构

```
bulksheet-saas/
├── backend_v2/                          # 后端主项目
│   ├── app/                             # 应用核心代码
│   │   ├── __init__.py
│   │   ├── main.py                      # FastAPI主应用 (207行)
│   │   ├── models.py                    # Pydantic数据模型 (48行)
│   │   ├── config/                      # 配置管理模块
│   │   │   ├── __init__.py              # 配置加载 (71行)
│   │   │   ├── ai_config.yaml           # AI配置文件
│   │   │   └── prompts/                 # 提示词目录
│   │   │       └── attribute_expert_v1.txt  # Prompt v1 (413行)
│   │   └── services/                    # AI服务层
│   │       ├── __init__.py
│   │       ├── ai_service.py            # 抽象接口 (26行)
│   │       └── deepseek_provider.py     # DeepSeek实现 (183行)
│   ├── requirements.txt                 # Python依赖
│   ├── .env                             # 环境变量（不纳入版本控制）
│   ├── .gitignore                       # Git忽略配置
│   └── .replit                          # Replit部署配置
├── 属性词扩展专家Prompt.md               # 原始Prompt文档
└── 项目需求文档.md                       # 本文档
```

### 3.5 数据流

```
用户请求
   ↓
FastAPI路由 (main.py)
   ↓
数据验证 (models.py - AttributeRequest)
   ↓
AI服务调用 (ai_service接口)
   ↓
DeepSeek Provider (deepseek_provider.py)
   ├── 加载配置 (ai_config.yaml)
   ├── 加载提示词 (attribute_expert_v1.txt)
   ├── 填充模板 (concept参数)
   └── HTTP请求 → DeepSeek API
   ↓
响应处理
   ├── JSON解析（处理markdown代码块）
   ├── 中文字段 → 英文字段转换
   └── 生成元数据统计
   ↓
数据序列化 (models.py - AttributeResponse)
   ↓
返回JSON响应
```

### 3.6 错误处理流程

```
API调用
   ↓
异常捕获 (try-except)
   ├── aiohttp.ClientError → 网络错误
   ├── json.JSONDecodeError → JSON解析错误
   ├── KeyError → 响应格式错误
   └── Exception → 其他未知错误
   ↓
错误日志输出
   ├── 错误类型
   ├── 错误消息
   └── 堆栈跟踪
   ↓
降级处理
   ├── 返回备用数据 (_get_fallback_attributes)
   └── 保证服务可用性
```

### 3.7 CORS配置

**允许的源**：
- `http://localhost:3000` (React开发服务器默认端口)
- `http://localhost:3001` (备用端口)

**允许的方法**：所有HTTP方法
**允许的头部**：所有头部
**允许凭证**：是

### 3.8 部署配置

#### Replit 部署
- **运行命令**: `uvicorn app.main:app --host 0.0.0.0 --port 8000`
- **环境变量**: 在Replit Secrets中配置`DEEPSEEK_API_KEY`
- **端口**: 8000

---

## 4. 后续功能规划

### 4.1 Stage 2：属性词筛选编辑

#### 4.1.1 功能描述

用户可以对AI生成的属性词候选列表进行交互式筛选和编辑：
- 勾选/取消勾选属性词
- 查看属性词详细信息（类型、翻译、适用场景）
- 按推荐度筛选（仅显示推荐词）
- 按类型筛选（原词、同义词、相近词、变体）
- 按搜索价值排序
- 保存筛选结果

#### 4.1.2 用户流程

```
查看属性词列表 → 筛选过滤 → 勾选需要的属性词 → 保存选择 → 进入Stage 3
```

#### 4.1.3 API设计

**端点**: `POST /api/stage2/select`

**请求体**:
```json
{
  "task_id": "550e8400-e29b-41d4-a716-446655440000",
  "selected_words": ["cute", "adorable", "lovely", "kawaii"],
  "filters": {
    "recommended_only": true,
    "types": ["original", "synonym", "related"],
    "min_search_value": "medium"
  }
}
```

**响应体**:
```json
{
  "task_id": "550e8400-e29b-41d4-a716-446655440000",
  "selected_count": 4,
  "selected_attributes": [
    {
      "word": "cute",
      "type": "original",
      "recommended": true
    }
  ],
  "metadata": {
    "saved_at": "2025-11-06T15:00:00Z"
  }
}
```

#### 4.1.4 数据模型

```python
class SelectionRequest(BaseModel):
    task_id: str
    selected_words: List[str]
    filters: Optional[FilterOptions] = None

class FilterOptions(BaseModel):
    recommended_only: bool = False
    types: Optional[List[Literal["original", "synonym", "related", "variant"]]] = None
    min_search_value: Optional[Literal["high", "medium", "low"]] = None

class SelectionResponse(BaseModel):
    task_id: str
    selected_count: int
    selected_attributes: List[SelectedAttribute]
    metadata: SelectionMetadata
```

#### 4.1.5 技术要点

**数据持久化**：
- 引入数据库（建议SQLite或PostgreSQL）
- 存储用户选择状态
- 关联task_id和选中的属性词

**状态管理**：
- 任务状态：draft（草稿）、completed（已完成）
- 支持保存后继续编辑

### 4.2 Stage 3：搜索词组合生成

#### 4.2.1 功能描述

将用户选中的属性词与本体词组合，生成完整的搜索关键词列表：
- 自动组合：每个属性词 + 本体词
- 支持多属性组合（可选）
- 去重处理
- 字符长度验证（亚马逊广告限制）
- 支持自定义组合规则

#### 4.2.2 用户流程

```
选择组合规则 → 预览搜索词 → 确认生成 → 查看完整搜索词列表 → 进入Stage 4
```

#### 4.2.3 组合逻辑

**基础组合**（默认）：
```
属性词 + 本体词
示例：
- cute + iphone 16 pro case = "cute iphone 16 pro case"
- adorable + iphone 16 pro case = "adorable iphone 16 pro case"
```

**高级组合**（可选）：
```
多属性组合：属性词1 + 属性词2 + 本体词
示例：
- cute + red + phone case = "cute red phone case"
- protective + waterproof + phone case = "protective waterproof phone case"
```

**组合规则**：
1. 属性词在前，本体词在后
2. 属性词之间用空格分隔
3. 最多3个属性词组合（避免过长）
4. 自动去除重复词汇
5. 验证字符长度（建议 ≤ 80字符）

#### 4.2.4 API设计

**端点**: `POST /api/stage3/combine`

**请求体**:
```json
{
  "task_id": "550e8400-e29b-41d4-a716-446655440000",
  "entity_word": "iphone 16 pro case",
  "selected_words": ["cute", "adorable", "lovely"],
  "combination_mode": "basic",
  "options": {
    "max_length": 80,
    "enable_multi_attribute": false,
    "max_attributes_per_combination": 2
  }
}
```

**响应体**:
```json
{
  "task_id": "550e8400-e29b-41d4-a716-446655440000",
  "search_terms": [
    {
      "term": "cute iphone 16 pro case",
      "attributes": ["cute"],
      "length": 24,
      "valid": true
    },
    {
      "term": "adorable iphone 16 pro case",
      "attributes": ["adorable"],
      "length": 28,
      "valid": true
    },
    {
      "term": "lovely iphone 16 pro case",
      "attributes": ["lovely"],
      "length": 27,
      "valid": true
    }
  ],
  "metadata": {
    "total_terms": 3,
    "valid_terms": 3,
    "invalid_terms": 0,
    "average_length": 26.3,
    "generated_at": "2025-11-06T15:30:00Z"
  }
}
```

#### 4.2.5 数据模型

```python
class CombinationRequest(BaseModel):
    task_id: str
    entity_word: str
    selected_words: List[str]
    combination_mode: Literal["basic", "advanced"] = "basic"
    options: Optional[CombinationOptions] = None

class CombinationOptions(BaseModel):
    max_length: int = 80
    enable_multi_attribute: bool = False
    max_attributes_per_combination: int = 2

class SearchTerm(BaseModel):
    term: str
    attributes: List[str]
    length: int
    valid: bool
    validation_message: Optional[str] = None

class CombinationResponse(BaseModel):
    task_id: str
    search_terms: List[SearchTerm]
    metadata: CombinationMetadata
```

#### 4.2.6 技术要点

**验证规则**：
- 字符长度验证（默认最大80字符）
- 去重验证（避免重复搜索词）
- 特殊字符过滤

**性能优化**：
- 对于大量属性词（>100），使用批量处理
- 异步生成搜索词

### 4.3 Stage 4：Bulksheet导出

#### 4.3.1 功能描述

将生成的搜索词导出为符合亚马逊广告规范的Bulksheet Excel文件：
- 支持Amazon Sponsored Products格式
- 自动填充必填字段
- 支持批量导出
- 提供Excel和CSV两种格式
- 支持自定义出价（Bid）

#### 4.3.2 亚马逊Bulksheet格式

**必填字段**：

| 字段名 | 说明 | 示例值 |
|--------|------|--------|
| Campaign Name | 广告活动名称 | "Phone Case Campaign" |
| Ad Group Name | 广告组名称 | "Cute iPhone Cases" |
| Keyword | 关键词 | "cute iphone 16 pro case" |
| Match Type | 匹配类型 | Exact/Phrase/Broad |
| Bid | 出价 | 0.50 |
| Status | 状态 | Enabled |

**可选字段**：
- Campaign Start Date
- Campaign End Date
- Campaign Budget
- Ad Group Max CPC

#### 4.3.3 API设计

**端点**: `POST /api/stage4/export`

**请求体**:
```json
{
  "task_id": "550e8400-e29b-41d4-a716-446655440000",
  "campaign_name": "Phone Case Campaign 2025",
  "ad_group_name": "Cute iPhone Cases",
  "match_type": "exact",
  "default_bid": 0.50,
  "format": "xlsx",
  "options": {
    "status": "enabled",
    "campaign_budget": 50.00,
    "start_date": "2025-11-10"
  }
}
```

**响应**:
```
Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet
Content-Disposition: attachment; filename="bulksheet_2025-11-06.xlsx"

[Excel文件二进制数据]
```

或JSON响应（包含下载链接）:
```json
{
  "task_id": "550e8400-e29b-41d4-a716-446655440000",
  "file_url": "/downloads/bulksheet_2025-11-06.xlsx",
  "file_size": 15360,
  "total_keywords": 15,
  "format": "xlsx",
  "generated_at": "2025-11-06T16:00:00Z"
}
```

#### 4.3.4 数据模型

```python
class ExportRequest(BaseModel):
    task_id: str
    campaign_name: str
    ad_group_name: str
    match_type: Literal["exact", "phrase", "broad"]
    default_bid: float
    format: Literal["xlsx", "csv"] = "xlsx"
    options: Optional[ExportOptions] = None

class ExportOptions(BaseModel):
    status: Literal["enabled", "paused"] = "enabled"
    campaign_budget: Optional[float] = None
    start_date: Optional[str] = None
    end_date: Optional[str] = None

class ExportResponse(BaseModel):
    task_id: str
    file_url: str
    file_size: int
    total_keywords: int
    format: str
    generated_at: str
```

#### 4.3.5 技术要点

**Excel生成**：
- 使用 `openpyxl` 库生成Excel文件
- 添加表头和数据验证
- 设置单元格格式（货币、日期等）

**文件存储**：
- 临时文件存储（自动清理）
- 或提供直接下载（流式传输）

**模板支持**（未来扩展）：
- 支持用户上传自定义Bulksheet模板
- 自动映射字段

### 4.4 额外功能（低优先级）

#### 4.4.1 批量处理

**功能**：一次处理多个属性概念

**端点**: `POST /api/batch/generate`

**请求体**:
```json
{
  "concepts": ["cute", "ocean", "protective"],
  "entity_word": "phone case",
  "parallel": true
}
```

#### 4.4.2 任务管理

**功能**：查询历史任务、删除任务

**端点**:
- `GET /api/tasks` - 列出所有任务
- `GET /api/tasks/{task_id}` - 查询单个任务
- `DELETE /api/tasks/{task_id}` - 删除任务

#### 4.4.3 用户认证

**功能**：用户注册、登录、API Key管理

**端点**:
- `POST /api/auth/register` - 用户注册
- `POST /api/auth/login` - 用户登录
- `GET /api/auth/me` - 获取当前用户信息

---

## 5. 开发路线图

### 5.1 开发优先级

| 阶段 | 功能 | 优先级 | 预计工作量 | 依赖关系 |
|------|------|--------|-----------|---------|
| ✅ Stage 1 | 属性词生成 | P0 | 已完成 | 无 |
| Stage 2 | 属性词筛选编辑 | P0 | 2-3周 | Stage 1 |
| Stage 3 | 搜索词组合生成 | P0 | 1-2周 | Stage 2 |
| Stage 4 | Bulksheet导出 | P0 | 1-2周 | Stage 3 |
| 额外功能 | 批量处理 | P1 | 1周 | Stage 1 |
| 额外功能 | 任务管理 | P1 | 1周 | Stage 2 |
| 额外功能 | 用户认证 | P2 | 2周 | 无 |
| 前端开发 | Web界面 | P1 | 4-6周 | Stage 1-4 API |

### 5.2 技术依赖关系

```
Stage 1 (已完成)
   ↓
[数据库集成] ← Stage 2 需要
   ↓
Stage 2
   ↓
Stage 3 (依赖Stage 2的选择结果)
   ↓
Stage 4 (依赖Stage 3的搜索词)
   ↓
完整工作流

并行开发：
- 批量处理（基于Stage 1）
- 任务管理（基于Stage 2）
- 用户认证（独立模块）
```

### 5.3 短期目标（1-2个月）

**目标**：完成核心工作流（Stage 1-4）

**里程碑**：
1. ✅ Stage 1完成（已完成）
2. 数据库集成（SQLite）
3. Stage 2开发和测试
4. Stage 3开发和测试
5. Stage 4开发和测试
6. 端到端集成测试

**交付物**：
- 完整的后端API
- API文档（OpenAPI/Swagger）
- 单元测试和集成测试
- 部署文档

### 5.4 中期目标（3-4个月）

**目标**：增强功能和用户体验

**里程碑**：
1. 前端Web应用开发
2. 批量处理功能
3. 任务管理功能
4. 性能优化
5. 错误监控和日志系统

**交付物**：
- 完整的Web应用
- 用户使用文档
- 性能测试报告

### 5.5 长期目标（6个月+）

**目标**：企业级功能和扩展

**里程碑**：
1. 用户认证和权限系统
2. 多租户支持
3. 更多AI提供商集成（OpenAI、Claude）
4. 高级分析功能（关键词效果分析）
5. 自定义Bulksheet模板
6. API限流和配额管理

**交付物**：
- 企业级SaaS平台
- 管理后台
- 数据分析报表

### 5.6 技术债务和优化

**当前技术债务**：
- [ ] 删除遗留代码（`deepseek_client.py`）
- [ ] 添加单元测试覆盖
- [ ] 引入结构化日志（logging模块）
- [ ] 添加API限流保护
- [ ] 优化错误处理和用户友好的错误消息

**性能优化计划**：
- [ ] 引入Redis缓存（缓存AI响应）
- [ ] 数据库查询优化（索引设计）
- [ ] 异步任务队列（Celery）
- [ ] API响应压缩

### 5.7 文档和测试

**文档待补充**：
- [ ] API文档（Swagger UI集成）
- [ ] 开发者指南
- [ ] 部署指南
- [ ] 用户手册

**测试待添加**：
- [ ] 单元测试（pytest）
- [ ] 集成测试
- [ ] 端到端测试
- [ ] 性能测试

---

## 附录

### A. 环境变量配置

```env
# DeepSeek API
DEEPSEEK_API_KEY=sk-xxxxx

# 数据库（未来）
DATABASE_URL=sqlite:///./bulksheet.db

# JWT密钥（未来）
SECRET_KEY=your-secret-key-here

# 日志级别
LOG_LEVEL=INFO
```

### B. 快速开始

#### 本地开发

1. **克隆项目**
```bash
git clone https://github.com/your-repo/bulksheet-saas.git
cd bulksheet-saas/backend_v2
```

2. **安装依赖**
```bash
pip install -r requirements.txt
```

3. **配置环境变量**
```bash
cp .env.example .env
# 编辑 .env 文件，添加 DEEPSEEK_API_KEY
```

4. **启动服务**
```bash
uvicorn app.main:app --reload
```

5. **测试API**
```bash
curl -X POST http://localhost:8000/api/stage1/generate \
  -H "Content-Type: application/json" \
  -d '{"concept": "ocean"}'
```

#### Replit部署

1. Fork项目到Replit
2. 在Secrets中配置`DEEPSEEK_API_KEY`
3. 点击Run按钮
4. 使用Replit提供的公网URL访问API

### C. 常见问题

**Q: API调用返回备用数据，如何排查？**
A: 检查以下几点：
1. 环境变量`DEEPSEEK_API_KEY`是否配置正确
2. 查看控制台日志，确认错误类型
3. 检查DeepSeek API余额和限流状态

**Q: 如何切换AI提供商？**
A:
1. 在`ai_config.yaml`中添加新提供商配置
2. 创建新的Provider类继承`AIService`
3. 修改`active_provider`为新提供商名称

**Q: 如何更新Prompt？**
A:
1. 创建新版本提示词文件：`attribute_expert_v2.txt`
2. 在`ai_config.yaml`中修改`prompt_version: "v2"`
3. 重启服务

**Q: 为什么pandas和openpyxl安装了但没有使用？**
A: 这两个库是为Stage 4（Bulksheet导出）预留的，当前Stage 1暂不需要。

### D. 贡献指南

**代码规范**：
- 遵循PEP 8编码规范
- 使用类型注解（Type Hints）
- 添加详细的文档字符串（Docstring）

**提交规范**：
- feat: 新功能
- fix: 修复bug
- docs: 文档更新
- refactor: 代码重构
- test: 测试相关
- chore: 构建/工具相关

**Pull Request流程**：
1. Fork项目
2. 创建功能分支（`git checkout -b feature/your-feature`）
3. 提交更改（`git commit -m "feat: add your feature"`）
4. 推送到分支（`git push origin feature/your-feature`）
5. 创建Pull Request

### E. 参考资料

- [FastAPI官方文档](https://fastapi.tiangolo.com/)
- [Pydantic官方文档](https://docs.pydantic.dev/)
- [DeepSeek API文档](https://platform.deepseek.com/docs)
- [亚马逊广告Bulksheet规范](https://advertising.amazon.com/API/docs/en-us/bulksheets)

---

**文档维护者**: 开发团队
**联系方式**: [项目GitHub Issues]
**最后更新**: 2025-11-06
